name: Deploy to Heroku

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
      - '*.*.*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        id: vars
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#v}
          else
            # Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ù…Ù† Releases Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø­Ø¯Ø« Ù‡Ùˆ Tag
            LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
            if [ -n "$LATEST_RELEASE" ]; then
              VERSION=${LATEST_RELEASE#v}
            else
              VERSION=$(node -p "require('./package.json').version")
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸš€ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù€ Heroku: $VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª
        env:
          APP_VERSION: ${{ steps.vars.outputs.version }}
        run: npm run update-version

      - name: Build Project
        run: npm run build
        env:
          VITE_APP_VERSION: ${{ steps.vars.outputs.version }}

      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "ratnzer-services" # ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬Ù‡ Ù…Ù† Ø±Ø§Ø¨Ø· API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          # Ù†Ø­Ù† Ù†Ø¯ÙØ¹ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
          branch: "main"
