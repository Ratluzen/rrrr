name: Deploy to Heroku

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
      - '*.*.*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        id: vars
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#v}
          else
            # Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ù…Ù† Releases Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø­Ø¯Ø« Ù‡Ùˆ Tag
            LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
            if [ -n "$LATEST_RELEASE" ]; then
              VERSION=${LATEST_RELEASE#v}
            else
              VERSION=$(node -p "require('./package.json').version")
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸš€ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù€ Heroku: $VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª
        env:
          APP_VERSION: ${{ steps.vars.outputs.version }}
        run: npm run update-version

      - name: Build Project
        run: npm run build
        env:
          VITE_APP_VERSION: ${{ steps.vars.outputs.version }}

      - name: Deploy to Heroku via Git Push
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ù„Ù€ Git
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø© Ø¹Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡ (Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
          # Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø­Ù† Ù†Ù‚ÙˆÙ… Ø¨Ø¹Ù…Ù„ commit Ù…Ø­Ù„ÙŠ ÙÙ‚Ø· Ù„Ù„Ø¯ÙØ¹ Ø¥Ù„Ù‰ heroku
          git add .
          git commit -m "chore: build and version update for deployment [skip ci]" || echo "No changes to commit"
          
          # Ø§Ù„Ø¯ÙØ¹ Ø¥Ù„Ù‰ Heroku
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ API Key Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙÙŠ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ remote
          git push -f https://:$HEROKU_API_KEY@git.heroku.com/ratnzer-services.git HEAD:refs/heads/main
